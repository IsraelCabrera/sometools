# Function to activate Python virtual environment
activate_venv() {
    local venv_dirs=("venv" ".venv" "env" ".env" "virtualenv")
    local activate_script="bin/activate"
    local found_venv=""
    
    # Detect OS and set appropriate activate script path
    case "$OSTYPE" in
        msys*|cygwin*)
            activate_script="Scripts/activate"
            ;;
        win32*)
            activate_script="Scripts/activate"
            ;;
    esac
    
    # Look for virtual environment in common directories
    for venv_dir in $venv_dirs; do
        if [[ -d "$venv_dir" && -f "$venv_dir/$activate_script" ]]; then
            found_venv="$venv_dir"
            break
        fi
    done
    
    # If no common directory found, look for any directory with activate script
    if [[ -z "$found_venv" ]]; then
        for dir in */; do
            if [[ -f "$dir/$activate_script" ]]; then
                found_venv="${dir%/}"
                break
            fi
        done
    fi
    
    if [[ -n "$found_venv" ]]; then
        echo "‚úÖ Activating virtual environment: $found_venv"
        source "$found_venv/$activate_script"
        
        # Show Python info after activation
        if command -v python >/dev/null 2>&1; then
            echo "üêç Python version: $(python --version 2>&1)"
            echo "üìÅ Python path: $(which python)"
        fi
        return 0
    else
        echo "‚ùå No virtual environment found"
        echo "üí° Common directories checked: ${venv_dirs[@]}"
        echo "üí° You can create one with: python -m venv venv"
        return 1
    fi
}

# Function to deactivate current virtual environment
deactivate_venv() {
    if [[ -n "$VIRTUAL_ENV" ]]; then
        echo "üëã Deactivating virtual environment: $(basename "$VIRTUAL_ENV")"
        deactivate
    else
        echo "‚ùå No virtual environment is currently active"
    fi
}

create_venv_by_module() {

    local python_cmd="$1"
    local module_command="$2"
    local venv_name="$3"
    local module_list_versions
    local module_set_local_version
    local module_check_version
    local module_install_version
    local selected_version

    case "$module_command" in
        pyenv*)
            module_list_versions="pyenv versions --bare | grep -v "system" | sort -V"
            module_set_local_version="pyenv local "
            module_check_version="pyenv versions --bare | grep -q "
            module_install_version="pyenv install "
            ;;
        uv*)
            module_list_versions="uv python list --only-installed | awk -F'-' '{print \$2}' | sort -uV | sort -rV"
            module_set_local_version="uv python pin "
            module_check_version="uv python list --only-installed | grep -q "
            module_install_version="uv python install "
            ;;
    esac

    if command -v "$module_command" &> /dev/null; then
        echo "üêç $module_command detected"
        
        # Get available Python versions
        local available_versions
        available_versions=$(eval $module_list_versions)
        
        if [[ -n "$available_versions" ]]; then
            echo "Available Python versions:"
            
            # Display versions in a numbered list
            local i=1
            local versions_array=()
            while IFS= read -r version; do
                versions_array+=("$version")
                echo "  $i) $version"
                ((i++))
            done <<< "$available_versions"
            
            echo "  $i) Use system Python"
            echo
            
            local choice
            read "choice?Select Python version (1 - $i, or enter version directly): "
            
            if [[ "$choice" =~ ^[0-9]+$ ]] && [[ $choice -ge 1 ]] && [[ $choice -le $i ]]; then
                if [[ $choice -eq $i ]]; then
                    echo "üîß Using system Python"
                else
                    selected_version="${versions_array[$((choice))]}"
                    echo "üîß Using Python $selected_version via $module_command"
                    
                    # Set local version for this directory
                    if ! eval "$module_set_local_version $selected_version"; then
                        echo "‚ò†Ô∏è error in selection version $selected_version"
                        return 1
                    fi
                fi
            elif [[ -n "$choice" ]]; then
                # User entered a version directly
                selected_version="$choice"
                
                # Check if the selected version is installed
                if ! eval "$module_check_version '$selected_version'"; then
                    echo "üì• Python version $selected_version not found. Installing/Upgrading..."
                    if eval "$module_install_version $selected_version"; then
                        echo "‚úÖ Successfully installed Python $selected_version"
                    else
                        echo "‚ùå Failed to install Python $selected_version"
                        echo "Using system Python"
                        selected_version=""
                    fi
                fi
                
                if [[ -n "$selected_version" ]]; then
                    echo "üîß Using Python $selected_version via $module_command"
                    eval "$module_set_local_version $selected_version"
                fi
            fi
        else
            echo "‚ÑπÔ∏è No $module_command versions available, using system Python"
        fi
    else
        echo "‚ÑπÔ∏è $module_command not found, using system Python"
    fi
    
    echo "üöÄ Creating virtual environment: $venv_name"
    
    # Create virtual environment
    case "$module_command" in
        pyenv*)
            if $python_cmd -c "import venv" 2>/dev/null; then
                if $python_cmd -m venv "$venv_name"; then
                    activate_venv
                else
                    echo "‚ùå Failed to create virtual environment"
                    return 1
                fi
            else
                echo "‚ùå venv module not available in selected Python version"
                return 1
            fi
            ;;
        uv*)
            if uv venv --python "$selected_version"; then
                activate_venv
            else
                echo "‚ò†Ô∏è Failed to create virtual environment"
                return 1
            fi
            ;;
    esac
}

# Function to create and activate a new virtual environment
create_venv() {
    local venv_name="${1:-venv}"
    
    if [[ -d "$venv_name" ]]; then
        echo "‚ö†Ô∏è Virtual environment '$venv_name' already exists"
        read -q "REPLY?Do you want to recreate it? [y/N] "
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -rf "$venv_name"
        else
            activate_venv
            return
        fi
    fi
    
    local python_cmd="python"
    if command -v uv &> /dev/null; then
        create_venv_by_module "$python_cmd" "uv" "$venv_name"
    elif command -v pyenv &> /dev/null; then
        create_venv_by_module "$python_cmd" "pyenv" "$venv_name"
    else
        echo "‚ò†Ô∏è No virtual environment manager available"
        read -p "‚ùì Would you want to install UV? [N/y] " -e -n 1 -r
        [[ "$REPLY" =~ ^[Yy]$ ]] || return 1
        curl -LsSf https://astral.sh/uv/install.sh | sh
    fi
}

venv() {
    # Main execution
    if [[ "$1" == "--deactivate" || "$1" == "-d" ]]; then
        deactivate_venv
    elif [[ "$1" == "--create" || "$1" == "-c" ]]; then
        create_venv "$2"
    elif [[ "$1" == "--help" || "$1" == "-h" ]]; then
        echo "üêç Python Virtual Environment Manager"
        echo ""
        echo "Usage:"
        echo "  $0                    - Activate existing virtual environment"
        echo "  $0 -d, --deactivate   - Deactivate current virtual environment"
        echo "  $0 -c, --create [name]- Create and activate new virtual environment"
        echo "  $0 -h, --help         - Show this help message"
        echo ""
        echo "Common virtual environment directories: venv, .venv, env, .env, virtualenv"
    else
        activate_venv
    fi    
}
